🔥 高优先级问题（建议尽快改，否则会在 Vue2/Webpack 上爆）
1) import.meta 会导致 Webpack/CJS 项目直接语法报错

你现在的入口注入片段是“一段代码同时尝试 Vite + Webpack”：
(import.meta).env?.DEV + process.env.NODE_ENV 混在一起



问题是：如果项目不是 ESM/不支持 import.meta，这不是运行时异常，而是“解析阶段语法错误”，try/catch 也救不了。Vue2 + Webpack（尤其老配置）非常可能中招。

同理，你的 discover.js 里直接引用 import.meta.glob，在不支持 import.meta 的打包器/解析器里同样可能炸



。

建议修法（推荐你走这个）：

不要生成“混合片段”。改成：

侦测到 Vite → 只注入 Vite 版入口片段（含 import.meta）

侦测到 Webpack/未知 → 只注入 Webpack 版片段（不出现 import.meta）

discover 也一样：分成两份模板 discover.vite.* / discover.webpack.*，init 时按 bundler 选一个写入，而不是 runtime 里兼容。

你之前方案里其实就建议了 adapter；这里就是 adapter 必须真正落地的地方。

2) runtime.resetEnv() 没有 per-hook try/catch，切场景可能被一个 hook 卡死

现在 reset 是：

for (const fn of toRun) await fn();


任何一个 hook throw 会让 reset 直接 reject，中断后续清理



。

这跟你 SDD-lite 的核心原则（切场景必须稳定清理）冲突。

建议：

对每个 hook 单独 try/catch，继续执行其他 hook

收集错误，最后统一 console.warn 或返回错误数组（不必 throw，最多 warn）

⚠️ 中优先级（不改也能跑，但会影响可维护性/升级体验）
3) “基础设施文件”用 writeIfAbsent，升级会漂移

init 对 Web 和小程序的 runtime/boot/discover 基本都是 writeIfAbsent：文件存在就跳过



。
这会导致：

你以后修了一个关键 bug（比如上面两条），老项目跑 init 也不会更新

只能靠人肉 diff

建议：

对全局基础设施改成 writeGenerated（你已经对 manifest 用了 @generated by sdd-lite 的策略，很好



）

提供 --force 或 --update：允许覆盖“带 generated header”的文件

4) TS CLI 目标 vs 当前实现（现在是 JS ESM）

你说要 Node + TS CLI，但现在 CLI 源码是 src/*.js，package.json type: module，bin 直接 import ../src/cli.js



。这不是“坏”，只是与你的目标不一致。

建议（不发布也很轻）：

用 tsup/esbuild 之类把 src/**/*.ts 构建到 dist/

bin/sdd-lite.js 指向 dist/cli.js

模板文件依旧字符串即可，不需要 TS 编译模板

🧪 小程序侧的两个小提醒
5) globalThis 在小程序环境的兼容性

你在 mp boot 里用 globalThis 挂 SDD



。多数情况下是 OK 的，但有些环境/工具链可能不稳定。

更稳的兜底：

优先 const g = globalThis ?? getApp?.() ?? {};

或者干脆不依赖全局：调试页直接 import listScenarios/runScenario 已经足够（你现在就这么做的）



。

6) manifest 更新策略

你现在只在 initMpWechat 最后生成 manifest



。但以后用户用 add-scenario 加了小程序场景，manifest 不会自动刷新（除非手工再跑 init）。

建议：

提供 sdd-lite manifest 命令（你已有 commands/manifest.js 生成逻辑



）

或者在 add-scenario 检测到是 mp 项目时顺便刷新

🌟 小优化（锦上添花）

doctor 目前同时跑 web + mp（只要存在 miniprogram 就跑 mp）



。可以加 --type 只检查一种，输出更干净。

extractField 用正则提 id/title 很轻量但易漏（比如 id 用变量、双引号、换行等）



。可以接受，doctor 是提示工具；但你可以把“缺字段”的级别降到 warn，别 fail。

我给你的“修复优先级清单”（最短路径）

拆分 Vite/Webpack 的入口注入与 discover 模板：彻底避开 import.meta 解析炸裂（最关键）



runtime.resetEnv per-hook try/catch：保证切场景不会因为一个 hook 卡死



全局基础设施改 writeGenerated + --update，让未来升级可控



小程序 add-scenario 后自动刷新 manifest（或提供 manifest 命令）



这四条改完，你这套脚手架就能比较放心地在 Vue2 / Vue3 / 小程序 多项目里反复使用了，而且不会因为“工程语法差异”莫名其妙翻车。